users_seen = set()

# –ë–∏–±–ª–∏–æ—Ç–µ–∫–∏ –¥–ª—è Telegram –±–æ—Ç–∞
from aiogram import Bot, Dispatcher
from aiogram.filters import Command  # –î–ª—è –∫–æ–º–∞–Ω–¥: /start, /help
from aiogram.types import Message  # –î–ª—è —Ä–∞–±–æ—Ç—ã —Å —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏

# –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ Python
import sqlite3  # –î–ª—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
import asyncio  # –î–ª—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–≥–æ –∫–æ–¥–∞
import random  # –î–ª—è —Å–ª—É—á–∞–π–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞ —Å–ª–æ–≤

TOKEN = "8415294070:AAFRW7U-bwsT-SJxGvbG6yZknLKmz6oc6qg"
bot = Bot(token=TOKEN)
dp = Dispatcher()
DB_FILE = "words.db"  # –ò–º—è —Ñ–∞–π–ª–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
current_quiz = {}  # –°–ª–æ–≤–∞—Ä—å –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–µ–∫—É—â–∏—Ö –∫–≤–∏–∑–æ–≤ {user_id: –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π_–æ—Ç–≤–µ—Ç}
users_seen = set()  # –ú–Ω–æ–∂–µ—Å—Ç–≤–æ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –∫–æ—Ç–æ—Ä—ã–µ —É–∂–µ –Ω–∞–∂–∞–ª–∏ —Å—Ç–∞—Ä—Ç


def create_database():
    """
    –°–æ–∑–¥–∞–µ–º –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–ª–æ–≤.
    """
    conn = sqlite3.connect(DB_FILE)  # –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
    cursor = conn.cursor()
    # –°–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—É "words"
    cursor.execute('''
    CREATE TABLE IF NOT EXISTS words (
        id INTEGER PRIMARY KEY,      -- –ù–æ–º–µ—Ä –∑–∞–ø–∏—Å–∏ (1, 2, 3...)
        user_id INTEGER,             -- ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è Telegram
        word TEXT,                   -- –°–ª–æ–≤–æ –Ω–∞ –∏–Ω–æ—Å—Ç—Ä–∞–Ω–Ω–æ–º
        translation TEXT             -- –ü–µ—Ä–µ–≤–æ–¥
    )
    ''')
    conn.commit()  # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
    conn.close()
    print("‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —Å–æ–∑–¥–∞–Ω–∞!")


def save_word(user_id, word, translation):
    """
    –°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å–ª–æ–≤–æ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö.

    """
    conn = sqlite3.connect(DB_FILE)  # –û—Ç–∫—Ä—ã–≤–∞–µ–º –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
    cursor = conn.cursor()
    # –í—Å—Ç–∞–≤–ª—è–µ–º –Ω–æ–≤—É—é –∑–∞–ø–∏—Å—å
    cursor.execute(
        "INSERT INTO words (user_id, word, translation) VALUES (?, ?, ?)",
        (user_id, word, translation)  # –ü–æ–¥—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è –≤–º–µ—Å—Ç–æ ? ? ?
    )
    conn.commit()  # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏ –∑–∞–∫—Ä—ã–≤–∞–µ–º
    conn.close()

    print(f"‚úÖ –°–ª–æ–≤–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ: {word} - {translation}")


def get_user_words(user_id):
    """
    –ü–æ–ª—É—á–∞–µ—Ç –≤—Å–µ —Å–ª–æ–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –±–∞–∑—ã.
    """
    conn = sqlite3.connect(DB_FILE)  # –û—Ç–∫—Ä—ã–≤–∞–µ–º –±–∞–∑—É
    cursor = conn.cursor()
    cursor.execute(  # –ò—â–µ–º —Å–ª–æ–≤–∞ —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        "SELECT word, translation FROM words WHERE user_id = ?",
        (user_id,)  # –ò—â–µ–º —Ç–æ–ª—å–∫–æ —Å–ª–æ–≤–∞ —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    )
    words = cursor.fetchall()  # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ —Å–ª–æ–≤
    conn.close()  # –ó–∞–∫—Ä—ã–≤–∞–µ–º –±–∞–∑—É

    return words  # –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å–ª–æ–≤–∞


@dp.message(Command("start"))
async def start_command(message: Message):
    """
    –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∫–æ–º–∞–Ω–¥—É /start.

    """
    user_id = message.from_user.id
    users_seen.add(user_id)  # –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –º–Ω–æ–∂–µ—Å—Ç–≤–æ

    await message.answer(
        "üëã –ü—Ä–∏–≤–µ—Ç! –Ø –±–æ—Ç –¥–ª—è –∏–∑—É—á–µ–Ω–∏—è —Å–ª–æ–≤.\n\n"
        "üìù –û—Ç–ø—Ä–∞–≤—å –º–Ω–µ —Å–ª–æ–≤–æ –∏ –ø–µ—Ä–µ–≤–æ–¥ —á–µ—Ä–µ–∑ —Ç–∏—Ä–µ:\n"
        "<code>apple - —è–±–ª–æ–∫–æ</code>\n\n"
        "üìö –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–ª–æ–≤–∞: /words\n"
        "üéØ –ö–≤–∏–∑: /quiz\n"
        "‚ùì –ü–æ–º–æ—â—å: /help",
        parse_mode="HTML"
    )


@dp.message(Command("help"))
async def help_command(message: Message):
    """
    –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∫–æ–º–∞–Ω–¥—É /help.
    –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é.

    """
    help_text = """
üìñ <b>–ü–æ–º–æ—â—å –ø–æ –±–æ—Ç—É:</b>

<b>–î–æ–±–∞–≤–∏—Ç—å —Å–ª–æ–≤–æ:</b>
–ü—Ä–æ—Å—Ç–æ –æ—Ç–ø—Ä–∞–≤—å —Å–ª–æ–≤–æ –∏ –ø–µ—Ä–µ–≤–æ–¥:
<code>hello - –ø—Ä–∏–≤–µ—Ç</code>
<code>book - –∫–Ω–∏–≥–∞</code>

<b>–ö–æ–º–∞–Ω–¥—ã:</b>
/start - –ù–∞—á–∞—Ç—å
/help - –≠—Ç–∞ —Å–ø—Ä–∞–≤–∫–∞  
/words - –ú–æ–∏ —Å–ª–æ–≤–∞
/quiz - –ö–≤–∏–∑ —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π

<b>–ü—Ä–∏–º–µ—Ä—ã:</b>
dog - —Å–æ–±–∞–∫–∞
cat - –∫–æ—Ç
house - –¥–æ–º
    """

    await message.answer(help_text, parse_mode="HTML")


@dp.message(Command("words"))
async def words_command(message: Message):
    """
    –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≤—Å–µ —Å–ª–æ–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

    """
    user_id = message.from_user.id  # –ü–æ–ª—É—á–∞–µ–º ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    words = get_user_words(user_id)  # –ü–æ–ª—É—á–∞–µ–º —Å–ª–æ–≤–∞ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
    # –ï—Å–ª–∏ —Å–ª–æ–≤ –Ω–µ—Ç
    if not words:
        await message.answer("üì≠ –£ —Ç–µ–±—è –ø–æ–∫–∞ –Ω–µ—Ç —Å–ª–æ–≤. –î–æ–±–∞–≤—å –ø–µ—Ä–≤–æ–µ!")
        return

    # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫ —Å–ª–æ–≤
    result = "üìö <b>–¢–≤–æ–∏ —Å–ª–æ–≤–∞:</b>\n\n"

    for i, (word, translation) in enumerate(words, 1):
        result += f"{i}. <code>{word}</code> - {translation}\n"

    await message.answer(result, parse_mode="HTML")


@dp.message(Command("quiz"))
async def quiz_command(message: Message):
    """
    –ö–≤–∏–∑ - –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–ª–æ–≤–æ –∏ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –æ—Ç–≤–µ—Ç.

    """
    user_id = message.from_user.id  # –ü–æ–ª—É—á–∞–µ–º ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    words = get_user_words(user_id)  # –ü–æ–ª—É—á–∞–µ–º —Å–ª–æ–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ —Å–ª–æ–≤–∞
    if not words:
        await message.answer("üì≠ –°–Ω–∞—á–∞–ª–∞ –¥–æ–±–∞–≤—å —Å–ª–æ–≤–∞ –∫–æ–º–∞–Ω–¥–æ–π /words!")
        return

    word, correct = random.choice(
        words)  # –í—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω–æ–µ —Å–ª–æ–≤–æ , word = –∞–Ω–≥–ª–∏–π—Å–∫–æ–µ —Å–ª–æ–≤–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä: "apple"), correct = –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–µ—Ä–µ–≤–æ–¥ (–Ω–∞–ø—Ä–∏–º–µ—Ä: "—è–±–ª–æ–∫–æ")
    current_quiz[user_id] = correct  # –ó–∞–ø–æ–º–∏–Ω–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç –¥–ª—è —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤–æ–ø—Ä–æ—Å
    await message.answer(
        f"üéØ <b>–ö–≤–∏–∑:</b>\n\n"
        f"–ö–∞–∫ –ø–µ—Ä–µ–≤–æ–¥–∏—Ç—Å—è —Å–ª–æ–≤–æ:\n"
        f"<code>{word}</code>\n\n"
        f"–ù–∞–ø–∏—à–∏ –ø–µ—Ä–µ–≤–æ–¥ –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏!\n",
        parse_mode="HTML"
    )


@dp.message()
async def handle_text(message: Message):
    """
    –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤—Å–µ –æ–±—ã—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è.
    –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç /start –¥–ª—è –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.
    """
    user_id = message.from_user.id

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–æ–≤—ã–π –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
    if user_id not in users_seen:
        users_seen.add(user_id)  # –î–æ–±–∞–≤–ª—è–µ–º –≤ –º–Ω–æ–∂–µ—Å—Ç–≤–æ
        # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
        await start_command(message)
        return

    text = message.text.strip()

    # –ø—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç–≤–µ—Ç –ª–∏ —ç—Ç–æ –Ω–∞ –∫–≤–∏–∑
    if user_id in current_quiz:
        user_answer = text.lower()  # –û—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        correct_answer = current_quiz[user_id].lower()  # –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç
        if user_answer == correct_answer:  # –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—Ç–≤–µ—Ç
            await message.answer(
                f"‚úÖ <b>–ü—Ä–∞–≤–∏–ª—å–Ω–æ! –û—Ç–ª–∏—á–Ω–æ! üéâ</b>\n\n"
                f"–°–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å: /quiz",
                parse_mode="HTML"
            )
        else:
            # –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç
            await message.answer(
                f"‚ùå <b>–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ...</b>\n\n"
                f"–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç: <b>{current_quiz[user_id]}</b>\n\n"
                f"–ü–æ–ø—Ä–æ–±—É–π –µ—â–µ —Ä–∞–∑: /quiz",
                parse_mode="HTML"
            )
        del current_quiz[user_id]  # –£–¥–∞–ª—è–µ–º –∫–≤–∏–∑ (—á—Ç–æ–±—ã —Å–ª–µ–¥—É—é—â–∏–π –æ—Ç–≤–µ—Ç –Ω–µ –ø—Ä–æ–≤–µ—Ä—è–ª—Å—è –∫–∞–∫ –∫–≤–∏–∑)
        return  # –í—ã—Ö–æ–¥–∏–º –∏–∑ —Ñ—É–Ω–∫—Ü–∏–∏

    # –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –ª–∏ —ç—Ç–æ —Å–ª–æ–≤–∞
    if " - " in text:
        parts = text.split(" - ")
        if len(parts) == 2:
            word = parts[0].strip()
            translation = parts[1].strip()

            if word and translation:  # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –±–∞–∑—É
                save_word(user_id, word, translation)
                await message.answer(  # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
                    f"‚úÖ <b>–°–ª–æ–≤–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ!</b>\n\n"
                    f"<code>{word}</code> ‚Üí {translation}\n\n"
                    f"–í—Å–µ–≥–æ —Å–ª–æ–≤: /words\n"
                    f"–ö–≤–∏–∑: /quiz",
                    parse_mode="HTML"
                )
                return
    await message.answer(  # –ï—Å–ª–∏ –¥—Ä—É–≥–æ–π —Ñ–æ—Ä–º–∞—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
        "ü§î <b>–ù–µ –ø–æ–Ω—è–ª...</b>\n\n"
        "<b>–î–æ–±–∞–≤–∏—Ç—å —Å–ª–æ–≤–æ:</b>\n"
        "<code>apple - —è–±–ª–æ–∫–æ</code>\n\n"
        "<b>–ö–æ–º–∞–Ω–¥—ã:</b>\n"
        "/start - –ù–∞—á–∞—Ç—å\n"
        "/help - –ü–æ–º–æ—â—å\n"
        "/words - –ú–æ–∏ —Å–ª–æ–≤–∞\n"
        "/quiz - –ö–≤–∏–∑",
        parse_mode="HTML"
    )


# –ó–ê–ü–£–°–ö –ë–û–¢–ê

async def main():
    """
    –ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è, –∑–∞–ø—É—Å–∫–∞–µ—Ç –±–æ—Ç–∞.

    """
    print("ü§ñ –ó–∞–ø—É—Å–∫–∞—é –±–æ—Ç–∞...")
    create_database()  # –°–æ–∑–¥–∞–µ–º –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
    await dp.start_polling(bot)  # –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞


if __name__ == "__main__":  # –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –≤ –ø—Ä–æ–≥—Ä–∞–º–º—É
    # –ó–∞–ø—É—Å–∫–∞–µ–º –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é main()
    asyncio.run(main())
